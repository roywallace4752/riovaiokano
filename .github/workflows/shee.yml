name: Tner

on:
  workflow_dispatch:
    inputs:
      run_duration:
        description: 'Runtime in hours (max 6)'
        required: false
        default: '5'

jobs:
  titan-node:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: System Information
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "         SYSTEM INFORMATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          uname -a
          echo "CPU: $(nproc) cores"
          free -h
          df -h /
          curl -s ifconfig.me && echo " (Public IP)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Download Titan Agent
        run: |
          echo "ğŸ“¥ Downloading Titan Agent..."
          
          # Ø±ÙˆØ´ Ø§ÙˆÙ„: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù„ÛŒÙ†Ú© test4
          if wget -q --show-progress https://pcdn.titannet.io/test4/bin/agent-linux.zip; then
            echo "âœ… Downloaded via test4 link"
            DOWNLOAD_FILE="agent-linux.zip"
          else
            echo "âš ï¸  First download failed, trying alternative..."
            # Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© Ø¨Ø§Ù„Ø§ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ø§Ø² GitHub Ø¨Ú¯ÛŒØ±
            wget -q --show-progress https://github.com/Titannet-dao/titan-agent/releases/latest/download/agent-linux-amd64.tar.gz
            DOWNLOAD_FILE="agent-linux-amd64.tar.gz"
          fi
          
          echo "Download file: $DOWNLOAD_FILE"
          ls -lh $DOWNLOAD_FILE

      - name: Extract and Setup
        run: |
          echo "ğŸ“¦ Extracting files..."
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯Ù‡
          if [ -f "agent-linux.zip" ]; then
            echo "Extracting ZIP file..."
            unzip -q agent-linux.zip
            
            # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡
            EXTRACT_DIR=$(find . -maxdepth 1 -type d -name "agent*" | head -1)
            
            if [ -z "$EXTRACT_DIR" ]; then
              echo "Creating titan_core directory..."
              mkdir -p titan_core
              mv agent titan_core/ 2>/dev/null || mv ./agent* titan_core/ 2>/dev/null
            else
              echo "Renaming $EXTRACT_DIR to titan_core..."
              mv "$EXTRACT_DIR" titan_core
            fi
            
          elif [ -f "agent-linux-amd64.tar.gz" ]; then
            echo "Extracting TAR.GZ file..."
            tar -xzf agent-linux-amd64.tar.gz
            
            EXTRACT_DIR=$(find . -maxdepth 1 -type d -name "*agent*" | head -1)
            if [ -n "$EXTRACT_DIR" ]; then
              mv "$EXTRACT_DIR" titan_core
            else
              mkdir -p titan_core
              mv agent* titan_core/ 2>/dev/null || true
            fi
          fi
          
          cd titan_core
          
          echo "ğŸ“ Directory contents:"
          ls -lah
          
          echo "ğŸ”§ Setting permissions..."
          # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ agent
          AGENT_FILE=$(find . -type f -name "agent" -o -name "titan-agent" | head -1)
          
          if [ -z "$AGENT_FILE" ]; then
            echo "âŒ Agent binary not found!"
            echo "Current directory structure:"
            find . -type f
            exit 1
          fi
          
          chmod +x "$AGENT_FILE"
          
          # Ø§ÛŒØ¬Ø§Ø¯ symlink Ø¨Ø±Ø§ÛŒ Ø±Ø§Ø­ØªÛŒ
          ln -sf "$AGENT_FILE" agent 2>/dev/null || true
          
          echo "âœ… Agent binary: $AGENT_FILE"
          file "$AGENT_FILE"

      - name: Start Titan Agent
        env:
          TITAN_HASH: ${{ secrets.TITAN_KEY }}
        run: |
          cd titan_core
          
          echo "ğŸš€ Starting Titan Agent..."
          echo "Hash: ${TITAN_HASH:0:4}***${TITAN_HASH: -4}"
          
          # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† binary
          AGENT_BIN=$(find . -type f \( -name "agent" -o -name "titan-agent" \) -executable | head -1)
          
          if [ -z "$AGENT_BIN" ]; then
            echo "âŒ Executable agent not found!"
            exit 1
          fi
          
          echo "Using binary: $AGENT_BIN"
          
          # Ø§Ø¬Ø±Ø§ÛŒ agent
          nohup "$AGENT_BIN" \
            --working-dir=$(pwd) \
            --server-url=https://test4-api.titannet.io \
            --key=${TITAN_HASH} \
            > titan-stdout.log 2> titan-stderr.log &
          
          AGENT_PID=$!
          echo $AGENT_PID > agent.pid
          
          echo "Agent PID: $AGENT_PID"
          
          echo "â³ Waiting for initialization (30s)..."
          sleep 30
          
          if ps -p $AGENT_PID > /dev/null; then
            echo "âœ… Agent is running!"
          else
            echo "âŒ Agent stopped!"
            echo "=== STDOUT ==="
            cat titan-stdout.log
            echo "=== STDERR ==="
            cat titan-stderr.log
            exit 1
          fi

      - name: Monitor Agent
        run: |
          cd titan_core
          
          RUNTIME_HOURS=${{ github.event.inputs.run_duration || '5' }}
          RUNTIME_SECONDS=$((RUNTIME_HOURS * 3600))
          AGENT_PID=$(cat agent.pid)
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   MONITORING FOR ${RUNTIME_HOURS} HOURS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Start: $(date)"
          echo "Dashboard: https://edge.titannet.io/deviceManagement"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          INTERVAL=300  # 5 minutes
          ELAPSED=0
          
          while [ $ELAPSED -lt $RUNTIME_SECONDS ]; do
            HOURS=$((ELAPSED / 3600))
            MINUTES=$(((ELAPSED % 3600) / 60))
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â° Runtime: ${HOURS}h ${MINUTES}m"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Process check
            if ! ps -p $AGENT_PID > /dev/null 2>&1; then
              echo "âŒ Agent stopped!"
              cat titan-stdout.log
              cat titan-stderr.log
              exit 1
            fi
            
            echo "âœ… Status: RUNNING"
            
            # Resources
            echo "ğŸ’» Resources:"
            ps -p $AGENT_PID -o %cpu,%mem,vsz,rss | tail -n 1 | \
              awk '{printf "   CPU: %s%% | MEM: %s%% | VSZ: %.1fMB | RSS: %.1fMB\n", $1, $2, $3/1024, $4/1024}'
            
            # Logs
            echo "ğŸ“‹ Recent STDOUT:"
            tail -n 3 titan-stdout.log 2>/dev/null | sed 's/^/   /' || echo "   No logs"
            
            echo "ğŸ“‹ Recent STDERR:"
            tail -n 2 titan-stderr.log 2>/dev/null | sed 's/^/   /' || echo "   No errors"
            
            # Network
            echo "ğŸŒ Network:"
            netstat -tn 2>/dev/null | grep ESTABLISHED | wc -l | \
              awk '{print "   Connections: "$1}'
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Monitoring completed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Final Report
        if: always()
        run: |
          cd titan_core 2>/dev/null || exit 0
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "         FINAL REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ -f agent.pid ]; then
            AGENT_PID=$(cat agent.pid)
            if ps -p $AGENT_PID > /dev/null 2>&1; then
              echo "âœ… Agent: RUNNING"
              pkill -P $AGENT_PID || true
              kill $AGENT_PID 2>/dev/null || true
            else
              echo "âš ï¸  Agent: STOPPED"
            fi
          fi
          
          echo ""
          echo "ğŸ“„ Complete STDOUT:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat titan-stdout.log 2>/dev/null || echo "No stdout"
          
          echo ""
          echo "ğŸ“„ Complete STDERR:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat titan-stderr.log 2>/dev/null || echo "No stderr"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ’¡ Next Steps:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "1. Check: https://edge.titannet.io/deviceManagement"
          echo "2. Device should appear within 5-15 minutes"
          echo "3. Download logs from Artifacts if needed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titan-logs-${{ github.run_number }}
          path: |
            titan_core/*.log
          retention-days: 7
          if-no-files-found: warn
