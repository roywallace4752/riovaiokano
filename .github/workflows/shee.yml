name: Tide (Complete Fix)

on:
  workflow_dispatch:
    inputs:
      run_duration:
        description: 'Runtime in hours (max 6)'
        required: false
        default: '5'

jobs:
  titan-node:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: System Info
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          uname -a
          echo "CPU: $(nproc) cores | RAM: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "Public IP: $(curl -s ifconfig.me)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Download Titan Agent
        run: |
          echo "ğŸ“¥ Downloading Titan Agent..."
          wget -q https://pcdn.titannet.io/test4/bin/agent-linux.zip
          ls -lh agent-linux.zip

      - name: Extract and Setup
        run: |
          echo "ğŸ“¦ Extracting..."
          unzip -q agent-linux.zip
          mkdir -p titan_core
          find . -name "agent" -o -name "titan-agent" -o -name "titan-edge" | head -1 | xargs -I {} mv {} titan_core/agent
          cd titan_core
          chmod +x agent
          echo "âœ… Agent ready: $(file agent)"

      - name: Bind Device to Account
        env:
          TITAN_HASH: ${{ secrets.TITAN_KEY }}
        run: |
          cd titan_core
          
          echo "ğŸ”— STEP 1: Binding device to account..."
          echo "Hash: ${TITAN_HASH:0:4}***${TITAN_HASH: -4}"
          
          # bind Ø¨Ø§ ØªÙ…Ø§Ù… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù…
          ./agent bind \
            --hash=${TITAN_HASH} \
            --working-dir=$(pwd) \
            --server-url=https://api-test1.container1.titannet.io \
            https://api-test1.container1.titannet.io/api/v2/device/binding
          
          BIND_EXIT=$?
          
          if [ $BIND_EXIT -eq 0 ]; then
            echo "âœ… Device bound successfully!"
          else
            echo "âš ï¸  Binding returned exit code: $BIND_EXIT"
            echo "Continuing anyway (might already be bound)..."
          fi
          
          echo ""
          echo "â³ Waiting 15 seconds for binding to register..."
          sleep 15

      - name: Start Daemon
        run: |
          cd titan_core
          
          echo "ğŸš€ STEP 2: Starting daemon..."
          
          # start daemon Ø¨Ø§ --init
          nohup ./agent daemon start \
            --init \
            --working-dir=$(pwd) \
            --server-url=https://api-test1.container1.titannet.io \
            > titan-stdout.log 2> titan-stderr.log &
          
          AGENT_PID=$!
          echo $AGENT_PID > agent.pid
          
          echo "Daemon PID: $AGENT_PID"
          
          echo "â³ Waiting for initialization (30s)..."
          sleep 30
          
          if ps -p $AGENT_PID > /dev/null; then
            echo "âœ… Daemon is running!"
          else
            echo "âŒ Daemon failed to start!"
            echo ""
            echo "=== STDOUT ==="
            cat titan-stdout.log 2>/dev/null || echo "No stdout"
            echo ""
            echo "=== STDERR ==="
            cat titan-stderr.log 2>/dev/null || echo "No stderr"
            exit 1
          fi

      - name: Display Node Info
        run: |
          cd titan_core
          echo "ğŸ“Š Node Information:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          ./agent info \
            --working-dir=$(pwd) \
            --server-url=https://api-test1.container1.titannet.io \
            2>&1 || echo "â„¹ï¸  Info command unavailable (normal)"

      - name: Monitor Node Activity
        run: |
          cd titan_core
          
          RUNTIME_HOURS=${{ github.event.inputs.run_duration || '5' }}
          RUNTIME_SECONDS=$((RUNTIME_HOURS * 3600))
          AGENT_PID=$(cat agent.pid)
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  MONITORING FOR ${RUNTIME_HOURS} HOURS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Start: $(date)"
          echo "End estimate: $(date -d "+${RUNTIME_HOURS} hours" 2>/dev/null || echo "N/A")"
          echo ""
          echo "ğŸ“ Dashboard: https://edge.titannet.io/deviceManagement"
          echo "â° Device should appear within 5-15 minutes"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          INTERVAL=300  # 5 minutes
          ELAPSED=0
          CHECK_COUNT=0
          
          while [ $ELAPSED -lt $RUNTIME_SECONDS ]; do
            CHECK_COUNT=$((CHECK_COUNT + 1))
            HOURS=$((ELAPSED / 3600))
            MINUTES=$(((ELAPSED % 3600) / 60))
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â° Check #${CHECK_COUNT} | Runtime: ${HOURS}h ${MINUTES}m | $(date '+%H:%M:%S')"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Process check
            if ! ps -p $AGENT_PID > /dev/null 2>&1; then
              echo "âŒ CRITICAL: Daemon stopped unexpectedly!"
              echo ""
              echo "Last 20 lines of stdout:"
              tail -n 20 titan-stdout.log 2>/dev/null
              echo ""
              echo "Last 20 lines of stderr:"
              tail -n 20 titan-stderr.log 2>/dev/null
              exit 1
            fi
            
            echo "âœ… Status: RUNNING (PID: $AGENT_PID)"
            
            # Resource usage
            ps -p $AGENT_PID -o %cpu,%mem,vsz,rss,etime 2>/dev/null | tail -n 1 | \
              awk '{printf "ğŸ’» CPU: %s%% | MEM: %s%% | VSZ: %.1fMB | RSS: %.1fMB | Uptime: %s\n", $1, $2, $3/1024, $4/1024, $5}'
            
            # Recent logs
            echo "ğŸ“‹ Last 3 stdout lines:"
            tail -n 3 titan-stdout.log 2>/dev/null | sed 's/^/   /' || echo "   (no output yet)"
            
            if [ -s titan-stderr.log ]; then
              echo "âš ï¸  Last 2 stderr lines:"
              tail -n 2 titan-stderr.log 2>/dev/null | sed 's/^/   /'
            fi
            
            # Network stats
            ESTABLISHED=$(netstat -tn 2>/dev/null | grep ESTABLISHED | wc -l)
            LISTENING=$(netstat -tln 2>/dev/null | grep LISTEN | wc -l)
            echo "ğŸŒ Network: ${ESTABLISHED} established, ${LISTENING} listening"
            
            # File stats
            LOG_SIZE_OUT=$(du -h titan-stdout.log 2>/dev/null | cut -f1)
            LOG_SIZE_ERR=$(du -h titan-stderr.log 2>/dev/null | cut -f1)
            echo "ğŸ“ Logs: stdout=${LOG_SIZE_OUT:-0}, stderr=${LOG_SIZE_ERR:-0}"
            
            # Working directory files
            FILE_COUNT=$(ls -1 | wc -l)
            echo "ğŸ“‚ Working dir: ${FILE_COUNT} files"
            
            echo ""
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… MONITORING COMPLETED SUCCESSFULLY!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Final Status Report
        if: always()
        run: |
          cd titan_core 2>/dev/null || { echo "titan_core not found"; exit 0; }
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "         FINAL STATUS REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Process status
          if [ -f agent.pid ]; then
            AGENT_PID=$(cat agent.pid)
            if ps -p $AGENT_PID > /dev/null 2>&1; then
              echo "âœ… Daemon Status: RUNNING"
              echo "   PID: $AGENT_PID"
              ps -p $AGENT_PID -o %cpu,%mem,vsz,rss,etime | tail -n 1 | \
                awk '{printf "   CPU: %s%% | MEM: %s%% | Uptime: %s\n", $1, $2, $5}'
              echo ""
              echo "ğŸ›‘ Stopping daemon gracefully..."
              kill -TERM $AGENT_PID 2>/dev/null || true
              sleep 3
              if ps -p $AGENT_PID > /dev/null 2>&1; then
                kill -KILL $AGENT_PID 2>/dev/null || true
              fi
              echo "âœ“ Daemon stopped"
            else
              echo "âš ï¸  Daemon Status: STOPPED"
              echo "   Last exit code: $(wait $AGENT_PID 2>&1; echo $?)"
            fi
          else
            echo "âš ï¸  No PID file found"
          fi
          
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“Š STATISTICS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          if [ -f titan-stdout.log ]; then
            STDOUT_LINES=$(wc -l < titan-stdout.log)
            STDOUT_SIZE=$(du -h titan-stdout.log | cut -f1)
            echo "STDOUT: ${STDOUT_LINES} lines, ${STDOUT_SIZE}"
          fi
          
          if [ -f titan-stderr.log ]; then
            STDERR_LINES=$(wc -l < titan-stderr.log)
            STDERR_SIZE=$(du -h titan-stderr.log | cut -f1)
            echo "STDERR: ${STDERR_LINES} lines, ${STDERR_SIZE}"
          fi
          
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“„ COMPLETE STDOUT LOG"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat titan-stdout.log 2>/dev/null || echo "(no stdout log)"
          
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“„ COMPLETE STDERR LOG"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat titan-stderr.log 2>/dev/null || echo "(no stderr log)"
          
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“ WORKING DIRECTORY CONTENTS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          ls -lah
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ’¡ NEXT STEPS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "1. âœ“ Check dashboard: https://edge.titannet.io/deviceManagement"
          echo "2. âœ“ Device should appear within 5-15 minutes"
          echo "3. âœ“ If not visible:"
          echo "   - Verify binding was successful (check logs above)"
          echo "   - Wait a bit longer (can take up to 30 min)"
          echo "   - Check you're logged into correct account"
          echo "4. âœ“ Download logs from Artifacts tab for analysis"
          echo "5. âœ“ If successful, deploy to your own server!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Upload Complete Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titan-complete-logs-${{ github.run_number }}
          path: |
            titan_core/*.log
            titan_core/agent.pid
          retention-days: 7
          if-no-files-found: warn
