name: Titde (Fixed)

on:
  workflow_dispatch:
    inputs:
      run_duration:
        description: 'Runtime in hours (max 6)'
        required: false
        default: '5'

jobs:
  titan-node:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: System Info
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          uname -a
          echo "CPU: $(nproc) cores | RAM: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "Public IP: $(curl -s ifconfig.me)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Download Titan Agent
        run: |
          echo "ğŸ“¥ Downloading Titan Agent..."
          wget -q https://pcdn.titannet.io/test4/bin/agent-linux.zip
          ls -lh agent-linux.zip

      - name: Extract and Setup
        run: |
          echo "ğŸ“¦ Extracting..."
          unzip -q agent-linux.zip
          mkdir -p titan_core
          find . -name "agent" -o -name "titan-agent" -o -name "titan-edge" | head -1 | xargs -I {} mv {} titan_core/agent
          cd titan_core
          chmod +x agent
          echo "âœ… Agent ready: $(file agent)"

      - name: Bind Device First (CRITICAL!)
        env:
          TITAN_HASH: ${{ secrets.TITAN_KEY }}
        run: |
          cd titan_core
          
          echo "ğŸ”— STEP 1: Binding device to account..."
          echo "Hash: ${TITAN_HASH:0:4}***${TITAN_HASH: -4}"
          
          # Ø§ÙˆÙ„ Ø¨Ø§ÛŒØ¯ bind Ú©Ù†ÛŒÙ…
          ./agent bind \
            --hash=${TITAN_HASH} \
            https://api-testnet.titannet.io/api/v2/device/binding
          
          if [ $? -eq 0 ]; then
            echo "âœ… Device bound successfully!"
          else
            echo "âŒ Binding failed! Trying alternative API..."
            ./agent bind \
              --hash=${TITAN_HASH} \
              https://api-test1.container1.titannet.io/api/v2/device/binding
          fi
          
          echo ""
          echo "â³ Waiting 10 seconds for binding to register..."
          sleep 10

      - name: Start Daemon
        run: |
          cd titan_core
          
          echo "ğŸš€ STEP 2: Starting daemon..."
          
          # Ø­Ø§Ù„Ø§ daemon Ø±Ùˆ start Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
          nohup ./agent daemon start --init \
            > titan-stdout.log 2> titan-stderr.log &
          
          AGENT_PID=$!
          echo $AGENT_PID > agent.pid
          
          echo "Daemon PID: $AGENT_PID"
          
          echo "â³ Waiting for initialization (30s)..."
          sleep 30
          
          if ps -p $AGENT_PID > /dev/null; then
            echo "âœ… Daemon is running!"
          else
            echo "âŒ Daemon failed!"
            echo "=== STDOUT ==="
            cat titan-stdout.log
            echo "=== STDERR ==="
            cat titan-stderr.log
            exit 1
          fi

      - name: Display Node Info
        run: |
          cd titan_core
          echo "ğŸ“Š Node Information:"
          ./agent info 2>/dev/null || echo "Info command not available"

      - name: Monitor Node
        run: |
          cd titan_core
          
          RUNTIME_HOURS=${{ github.event.inputs.run_duration || '5' }}
          RUNTIME_SECONDS=$((RUNTIME_HOURS * 3600))
          AGENT_PID=$(cat agent.pid)
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  MONITORING FOR ${RUNTIME_HOURS} HOURS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Start: $(date)"
          echo "Dashboard: https://edge.titannet.io/deviceManagement"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  IMPORTANT: Device should appear in dashboard within 5-15 minutes!"
          echo ""
          
          INTERVAL=300
          ELAPSED=0
          
          while [ $ELAPSED -lt $RUNTIME_SECONDS ]; do
            HOURS=$((ELAPSED / 3600))
            MINUTES=$(((ELAPSED % 3600) / 60))
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â° Runtime: ${HOURS}h ${MINUTES}m | $(date '+%H:%M:%S')"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if ! ps -p $AGENT_PID > /dev/null 2>&1; then
              echo "âŒ Daemon stopped!"
              cat titan-stdout.log titan-stderr.log
              exit 1
            fi
            
            echo "âœ… Status: RUNNING"
            
            ps -p $AGENT_PID -o %cpu,%mem,vsz,rss 2>/dev/null | tail -n 1 | \
              awk '{printf "ğŸ’» CPU: %s%% | MEM: %s%% | VSZ: %.1fMB | RSS: %.1fMB\n", $1, $2, $3/1024, $4/1024}'
            
            echo "ğŸ“‹ Recent stdout:"
            tail -n 3 titan-stdout.log 2>/dev/null | sed 's/^/   /' || echo "   No output"
            
            if [ -s titan-stderr.log ]; then
              echo "âš ï¸  Recent stderr:"
              tail -n 2 titan-stderr.log | sed 's/^/   /'
            fi
            
            netstat -tn 2>/dev/null | grep ESTABLISHED | wc -l | \
              awk '{print "ğŸŒ Connections: "$1}'
            
            echo ""
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Monitoring completed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Final Report
        if: always()
        run: |
          cd titan_core 2>/dev/null || exit 0
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "         FINAL REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ -f agent.pid ]; then
            AGENT_PID=$(cat agent.pid)
            if ps -p $AGENT_PID > /dev/null 2>&1; then
              echo "âœ… Daemon: RUNNING"
              echo "Stopping gracefully..."
              kill $AGENT_PID 2>/dev/null || true
              sleep 2
            else
              echo "âš ï¸  Daemon: STOPPED"
            fi
          fi
          
          echo ""
          echo "ğŸ“„ Complete STDOUT:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat titan-stdout.log 2>/dev/null || echo "No stdout"
          
          echo ""
          echo "ğŸ“„ Complete STDERR:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat titan-stderr.log 2>/dev/null || echo "No stderr"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ’¡ NEXT STEPS:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "1. Check dashboard: https://edge.titannet.io/deviceManagement"
          echo "2. Device should appear within 5-15 minutes after binding"
          echo "3. If not visible, check binding was successful in logs"
          echo "4. Try running again or contact Titan support"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titan-logs-${{ github.run_number }}
          path: titan_core/*.log
          retention-days: 7
          if-no-files-found: warn
