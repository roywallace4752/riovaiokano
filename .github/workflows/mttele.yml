name: Ultimate MTProto Proxy (Public Test Mode)

on:
  workflow_dispatch: 

jobs:
  run-proxy:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ۱. بهینه‌سازی شبکه برای سرعت بالا در ایران [۷۳۴]
      - name: Enable TCP BBR
        run: |
          sudo modprobe tcp_bbr
          echo "net.core.default_qdisc=fq" | sudo tee -a /etc/sysctl.conf
          echo "net.ipv4.tcp_congestion_control=bbr" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p

      # ۲. اتصال به Tailscale با تگ مخصوص [۸۵۹]
      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          tags: tag:ci

      # ۳. نصب mtg و تولید رمز (بدون ماسک کردن برای نمایش در لاگ) [۱۶، ۷۳۳]
      - name: Install mtg & Generate Public Secret
        run: |
          VERSION=$(curl -s https://api.github.com/repos/9seconds/mtg/releases/latest | grep tag_name | cut -d '"' -f 4 | sed 's/v//')
          wget https://github.com/9seconds/mtg/releases/download/v${VERSION}/mtg-${VERSION}-linux-amd64.tar.gz
          tar -xf mtg-${VERSION}-linux-amd64.tar.gz
          
          # پیدا کردن فایل اجرایی در پوشه‌های استخراج شده [۷۳۳]
          BINARY_PATH=$(find . -name "mtg" -type f | head -n 1)
          sudo mv "$BINARY_PATH" /usr/local/bin/mtg
          sudo chmod +x /usr/local/bin/mtg

          # تولید ee-secret برای مایکروسافت (Fake-TLS 1.3) [۷۱۸]
          DYNAMIC_SECRET=$(mtg generate-secret --hex microsoft.com)
          
          # چاپ مستقیم در لاگ برای کپی کردن کلاینت [۷۳۷]
          echo "------------------------------------------------------------"
          echo "YOUR MTPROTO SECRET IS: $DYNAMIC_SECRET"
          echo "------------------------------------------------------------"
          
          # ذخیره برای استفاده در مرحله بعد
          echo "MTG_SECRET=$DYNAMIC_SECRET" >> $GITHUB_ENV

      # ۴. اجرای پروکسی و Funnel روی پورت ۴۴۳ [۷۲۵، ۸۳۶]
      - name: Start Proxy and Funnel
        run: |
          # اجرای موتور mtg روی پورت ۳۰۰۰ [۷۳۳]
          mtg simple-run -c 16384 127.0.0.1:3000 "${{ env.MTG_SECRET }}" &
          
          # فعال‌سازی Funnel (با تنظیمات ACL جدید خطایی نخواهد داد) [۸۳۲]
          sudo tailscale funnel --bg --tls-terminated-tcp 443 3000
          
          echo "------------------------------------------------------------"
          echo "SUCCESS: MTProto Proxy is now LIVE on port 443"
          echo "Server (Host): $(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//')"
          echo "Port: 443"
          echo "Secret: ${{ env.MTG_SECRET }}"
          echo "------------------------------------------------------------"

      # ۵. زنده نگه داشتن رانر برای استفاده [۷۲۱]
      - name: Keepalive Runner
        run: |
          echo "The proxy will be active for 6 hours. Enjoy!"
          sleep 21000
